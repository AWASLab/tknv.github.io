---
layout: post
title: O:TFSの復旧パターン1
date: '2009-08-05T12:57:00.001+09:00'
author: tknv
comments: true
tags:
- TFS
- windows
modified_time: '2009-08-05T13:04:14.907+09:00'
blogger_id: tag:blogger.com,1999:blog-2736766923155041598.post-1644808251608657642
blogger_orig_url: http://yet-another-problem.blogspot.com/2009/08/otfs1.html
---

<h2>TFSの復旧パターン1:同一マシン、同一マシン名、まったく同一環境での復旧</h2><br /><br /><div><br /><div><h4>復旧前の準備、各サービスの停止</h4></div><br /><div>スタート &gt; 管理ツール &gt; サービス &gt; </div></div><br /><ul><br /><li>Visual Studio Team Foundation Server Task Scheduler を停止</li><br /><li>SharePoint Timer Serviceを停止</li></ul><br /><div>&nbsp;</div><br /><div>スタート &gt; 管理ツール &gt; IIS マネージャ &gt; 左ペインのアプリケーションプール &lt;展開&gt; </div><br /><ul><br /><li><br /><div>&gt; Microsoft Team Foundation Server Application Pool を右クリック &gt; [停止]</div></li><br /><li><br /><div>&gt; ReportServer を右クリック &gt; [停止]</div></li></ul><br /><div>&nbsp;</div><br /><div>スタート &gt; Reporting Services 構成 &gt; TFSで使用しているインスタンス名であるか確認し(MSSQLSERVER)、接続</div><br /><div>&gt; サーバの状態 &gt; [インスタンスのプロパティ]にある[停止] をクリック</div><br /><div>&nbsp;</div><br /><div><h4>復旧</h4></div><br /><br /><div>スタート &gt; SQL Server MAnagement Studio &gt; サーバの種類:データベースエンジンで接続 &gt; <br><br><ul><li>復元するデータベースを右クリックし、[タスク] をポイントします。次に、[復元] をポイントし、[データベース] をクリックします。</li><li>[データベースの復元] ダイアログ ボックスが表示されます。</li><li>[復元用のソース] で [デバイスから] をクリックし、省略記号ボタン ([…]) をクリックします。</li><li>[バックアップの指定] ダイアログ ボックスで、バックアップ ファイルの場所を指定し、[OK] をクリックします。</li><li>最初に完全バックアップを適用した後、トランザクション ログ バックアップを作成順に適用する必要があります。</li><li>[復元するバックアップ セットの選択] で、復元するバックアップ セットを指定します。</li><li>[ページの選択] ペインで、[オプション] をクリックし、[既存のデータベースを上書きする] チェック ボックスをオンにします。</li><li>[次のデータベース ファイルに復元] ボックスで、指定されているパスが現在のデータベースのパスと一致していることを確認します。</li><li>[復旧状態] で、適切な状態をクリックします。</li></ul><div style="margin-left: 40px;"><span style="color: rgb(255, 0, 0);"><span style="color: rgb(0, 0, 0);">(ReportServerとReportServer TempDBは、RESTORE WITH RECOVERYを選択した。トランザクションログがないため)</span><br></span><span style="color: rgb(255, 0, 0);">RESTORE WITH RECOVERYを選択したDB<br></span><ul style="color: rgb(255, 0, 0);"><li>ReportServer</li><li>ReportServerTempDB</li></ul><br><span style="color: rgb(255, 0, 0);">RESTORE WITH NORECOVERYを選択したDB<br></span><ul><li style="color: rgb(255, 0, 0);">TfsBuild</li><li style="color: rgb(255, 0, 0);">TfsIntegration</li><li style="color: rgb(255, 0, 0);">TfsVersionControl</li><li style="color: rgb(255, 0, 0);">TFSWarehouse</li><li style="color: rgb(255, 0, 0);">TfsWorkItemTracking</li><li style="color: rgb(255, 0, 0);">TfsWorkItemTrackingAttachments</li><li style="color: rgb(255, 0, 0);">TfsActivityLogging</li></ul><h3 style="color: rgb(255, 0, 0);"><b>WSS関係のDBはここでは復元しない。</b></h3><br></div><ul><li>[OK]をクリック<br></li></ul><br><div style="margin-left: 40px;">ReportServerとReportServer TempDBは、上記の復旧のみであるが、ほかのDBは、上記の操作後、復旧中になる。<br>再度、ReportServerとReportServer TempDB以外のDBを右クリックすると、復元項目にトランザクションログが追加される。<br><br><br /><ul><li>復元するデータベースを右クリックし、[タスク] をポイントします。次に、[復元] をポイントし、[トランザクションログ] をクリックします。</li><li>[データベースの以前のバックアップから]でDB名が正しいことを確認</li><li>DB名-トランザクション　ログ　バックアップ　にチェックが入っていることを確認</li><li style="color: rgb(0, 0, 0);">[ページの選択] ペインで、[オプション] をクリックし、[復旧状態]で RESTORE WITH RECOVERYを選択した。</li><li style="color: rgb(0, 0, 0);">[OK]をクリック</li></ul></div><br><div style="margin-left: 40px;">上記をすべてのDBで行う。<br></div><div style="margin-left: 40px;"><br></div><br><i>[復旧状態の簡単な説明]</i><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 追加のトランザクション ログを適用しない場合は、[データベースを使用可能な状態にする] をクリックします。=&gt;RESTORE WITH RECOVERYのこと。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 追加のトランザクション ログを適用する場合は、[データベースは操作不可能状態のまま] をクリックします。=&gt;<br><br>[OK] をクリックして、[データベースの復元] ダイアログ ボックスを閉じ、データベースを復元します。<br><br>追加のトランザクション ログを適用する場合は、適用するログのバックアップ セットが作成された順序に従い、各セットに対してこの手順を実行します。完全バックアップ後に作成されたログ バックアップに対してこの手順を実行するようにしてください。 <br></div><br /><div>&nbsp;<br><h4>Team Foundation アプリケーション層サーバのアクティブ化</h4><div style="margin-left: 40px;">cmd.exeにて<br><br />&gt;cd ~ProgramFiles\Microsoft Visual Studio 2008 Team Foundation Server\Tools<br>&gt;TfsAdminUtil Activate <b>WS2003STD</b><br></div></div><br /><div><br /></div><br /><div><h4>&nbsp;チームプロジェクト Webサイトの復元</h4><br>スタート &gt; 管理ツール &gt; SharePoint 3.0 サーバの全体管理<br>[サーバの全体管理] &gt; [SharePoint Web アプリケーション構成の管理] &gt; [ コンテンツデータベース] をクリック<br>[コンテンツデータベースの管理] &gt; [WSS_Content]をクリック<br>[ コンテンツデータベース設定の管理] &gt; [コンテンツデータベースの削除]にチェック、[OK]をクリック<br>[コンテンツデータベースの追加] &gt; [ データベースの情報] &gt; [データベースサーバー設定の指定] をクリック<br>[データベース名]:WSS_Content<br>[データベース容量の設定]の<br>[警告が～]:9000<br>[このデータ～]:15000<br>[OK]をクリック<br>スタート &gt; 管理ツール &gt; サービス &gt; SharePoint Timer Service を開始<br><br><h4>SQL Server Reporting Services および既定のレポートの復元およびテスト<br /> </h4><br><div>スタート &gt; 管理ツール &gt; IIS マネージャ &gt; 左ペインのアプリケーションプール &lt;展開&gt; </div><br /><br /><br /><div><ul><li>&gt; ReportServer を右クリック &gt; [開始]</li></ul></div><br><div>スタート &gt; Reporting Services 構成 &gt; TFSで使用しているインスタンス名であるか確認し(MSSQLSERVER)、接続</div><br /><div><ul><li>&gt; サーバの状態 &gt; [インスタンスのプロパティ]にある[開始] をクリック</li><li>&gt; 左のペインで [データベースのセットアップ]をクリック</li></ul><div style="margin-left: 40px;">サーバ名(WS2003STD)、データベース名(ReportServer)が正しいことを確認し [接続]をクリック<br>[<span class="ui">SQL Server 接続ダイアログ]</span> ダイアログ ボックスで、<span class="ui">[OK]</span> をクリックします。<br>[適用]をクリック<br>[<span class="ui">SQL Server 接続ダイアログ]</span> ダイアログ ボックスで、<span class="ui">[OK]</span> をクリックします。<br></div><br><ul><li>&gt; 左のペインで [暗号化キー]をクリック</li></ul><div style="margin-left: 40px;">:パスワードにいつものを入力<br>:キー　ファイルに構築時に保存した、tfsrecover.snkを指定(ファイル名は保存されているもの)<br><br></div><ul><li>&gt; 左のペインで [初期化]をクリック</li></ul><div style="margin-left: 40px;">古いTFSのデータ層サーバの名前に対応するインスタンスを選択し、<span style="background-color: rgb(204, 204, 204); color: rgb(153, 153, 153);">[削除]</span>をクリックして[OK]をクリック<br><span style="color: rgb(255, 0, 0);">※同一環境での復旧のため、インスタンスIDが変わらないので、削除ではなく初期化<br>異なる環境の場合は、古いTFSのデータ層サーバの名前に対応するインスタンスを削除<span id="nlkj" class="writely-comment" style="background-color: rgb(255, 255, 215);">ここについては、要確認 -takanobu watanabe 6/8/09 5:47 PM</span>&nbsp;</span><br><br><span style="color: rgb(255, 0, 0);">保険として、このインスタンスIDが表示されいる画面のキャプチャを取る。<br><br></span></div><h4 style="color: rgb(0, 0, 0);">SQL Server Reporting Services での作業</h4><div style="margin-left: 40px;">TFSのサーバのローカルでIEを立ち上げ、http://localhost/reportsに接続　&gt; コンテンツ &gt; TfsReportDS をクリック<br>名前:<b>TfsReportDS</b><br><b>このデータソースを有効にするにチェック</b><br>接続の種類:<b>Microsoft SQL Server</b><br>接続文字列:<b>Data source=WS2003STD;initial</b><br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp; <b>Catalog=TfsWarehouse</b><br>接続に使用する認証:<b>レポートサーバに保存され、セキュリティで保護された資格情報</b><br>ユーザ名:<b>WS2003STD\TFSSERVICE</b><br>パスワード:<b>いつもの</b><br><b>データソースへの接続時にWindows資格情報として使用するにチェック</b><br>[適用]をクリック<br><br>ホーム &gt; TfsOlapReportDS をクリック<br>名前:<b>TfsOlapReportDS</b><br><b>このデータソースを有効にするにチェック</b><br>接続の種類:<b>Microsoft SQL Server</b><br>接続文字列:<b>Data source=WS2003STD;initial</b><br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp; <b>Catalog=TfsWarehouse</b><br>接続に使用する認証:<b>レポートサーバに保存され、セキュリティで保護された資格情報</b><br>ユーザ名:<b>WS2003STD\TFSSERVICE</b><br>パスワード:<b>いつもの</b><br><b>データソースへの接続時にWindows資格情報として使用するにチェック</b><br>[適用]をクリック<br><br><br>cmd.exeにて<br><u style="color: rgb(153, 153, 153);">&gt;cd ~ProgramFiles\Microsoft Visual Studio 2008 Team Foundation Server\Tools<br>&gt;SetupWarehouse.exe -o -s WS2003STD -d TfsWarehouse -c warehouseschema.xml -ra TFSREPORT -a TFSSERVICE -mturl http://WS2003STD:8080<br></u>参考にしたドキュメント(MSDNのサイト）に間違えがある?、どうやっても上記のコマンドが通らない。<br><br>&gt;<b>TfsAdminUtil ConfigureConnections /view<br>返り値<br></b><span style="background-color: rgb(255, 255, 255); color: rgb(56, 118, 29);">TfsAminUtil ConfigureConnections /view</span><br style="background-color: rgb(255, 255, 255); color: rgb(56, 118, 29);"><span style="background-color: rgb(255, 255, 255); color: rgb(56, 118, 29);">TfsAdminUtil - Team Foundation Admin Utility</span><br style="background-color: rgb(255, 255, 255); color: rgb(56, 118, 29);"><span style="background-color: rgb(255, 255, 255); color: rgb(56, 118, 29);">Copyright (C) Microsoft Corporation. All rights reserved.</span><br style="background-color: rgb(255, 255, 255); color: rgb(56, 118, 29);"><br style="background-color: rgb(255, 255, 255); color: rgb(56, 118, 29);"><span style="background-color: rgb(255, 255, 255); color: rgb(56, 118, 29);">VSTS クライアント証明書は現在構成されていません。これはエラー条件ではありません。</span><br style="background-color: rgb(255, 255, 255); color: rgb(56, 118, 29);"><span style="background-color: rgb(255, 255, 255); color: rgb(56, 118, 29);">ATUri の現在の値&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = http://WS2003STD:8080</span><br style="background-color: rgb(255, 255, 255); color: rgb(56, 118, 29);"><span style="background-color: rgb(255, 255, 255); color: rgb(56, 118, 29);">PublicATUri は現在設定されていません。これはエラー条件ではありません。</span><br style="background-color: rgb(255, 255, 255); color: rgb(56, 118, 29);"><span style="background-color: rgb(255, 255, 255); color: rgb(56, 118, 29);">SharepointUri の現在の値&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = http://WS2003STD:80</span><br style="background-color: rgb(255, 255, 255); color: rgb(56, 118, 29);"><span style="background-color: rgb(255, 255, 255); color: rgb(56, 118, 29);">SharepointSitesUri の現在の値&nbsp; = http://WS2003STD:80/Sites</span><br style="background-color: rgb(255, 255, 255); color: rgb(56, 118, 29);"><span style="background-color: rgb(255, 255, 255); color: rgb(56, 118, 29);">SharepointAdminUri の現在の値&nbsp; = http://WS2003STD:17012/_vti_adm/admin.asmx</span><br style="background-color: rgb(255, 255, 255); color: rgb(56, 118, 29);"><span style="background-color: rgb(255, 255, 255); color: rgb(56, 118, 29);">SharepointUnc の現在の値&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = \\WS2003STD\Sites</span><br style="background-color: rgb(255, 255, 255); color: rgb(56, 118, 29);"><span style="background-color: rgb(255, 255, 255); color: rgb(56, 118, 29);">ReportsUri の現在の値&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = http://WS2003STD/Reports</span><br style="background-color: rgb(255, 255, 255); color: rgb(56, 118, 29);"><span style="background-color: rgb(255, 255, 255); color: rgb(56, 118, 29);">ReportServerUri の現在の値&nbsp;&nbsp;&nbsp;&nbsp; = http://WS2003STD/ReportServer/ReportService.asmx</span><br><br>上記の返り値を参考に値を入れる。<br><span class="placeholder">NewReports : </span><span style="background-color: rgb(255, 255, 255); color: rgb(56, 118, 29);">http://WS2003STD/Reports<br></span><span class="placeholder">NewReportServer : </span><span style="background-color: rgb(255, 255, 255); color: rgb(56, 118, 29);">http://WS2003STD/ReportServer/ReportService.asmx</span><p style="margin-right: 0px; margin-left: 0px;"><br /> <b>&gt;TfsAdminUtil ConfigureConnections /ReportsUri:</b><span class="placeholder">NewReports</span><b>/ReportServerUri:</b><span class="placeholder">NewReportServer</span></p><p style="margin-right: 0px; margin-left: 0px;"><b>返り値</b></p><p style="margin-right: 0px; margin-left: 0px; color: rgb(56, 118, 29);">TfsAdminUtil - Team Foundation Admin Utility<br>Copyright (C) Microsoft Corporation. All rights reserved.<br><br>SQL レポートの URI は指定された値 http://ws2003std/Reports/ReportsServerUri:http<br>://WS2003STD/ReportServer/ReportService.asmx に正常に設定されました<br>Windows SharePoint Services サイトまたは SQL Server Reporting Services サイトの<br>URI (Uniform Resource Identifier) が変更されました。Team Foundation Server は、<br>これらのサイトの少なくとも 1 つに依存しています。Team Foundation Server を正常に<br>動作させるには、Windows SharePoint Services が実行されているコンピュータで TfsCo<br>nfigWss コマンド ライン ユーティリティを実行する必要があります。</p><p style="margin-right: 0px; margin-left: 0px; color: rgb(56, 118, 29);"><br></p><p style="margin-right: 0px; margin-left: 0px;"><br /> <b>&gt;TfsConfigWss</b></p><p style="margin-right: 0px; margin-left: 0px;">ダイアログで下記の項目を入力するところがあるので、下記の左記を入力する。</p><p style="margin-right: 0px; margin-left: 0px;">Windows SharePoint Service : http://WS2003STD:80/sites<br></p><p style="margin-right: 0px; margin-left: 0px;">Reporting Services レポートサイト :  http://WS2003STD:80/Reports</p><p style="margin-right: 0px; margin-left: 0px;">Reporting Services管理サイト :  http://WS2003STD:80/ReportServer</p><p style="margin-right: 0px; margin-left: 0px;"><br></p><p style="margin-right: 0px; margin-left: 0px;">スタート &gt; 管理ツール &gt; IIS &gt; Microsoft Team Foundation Server アプリケーション プール 開始</p><p style="margin-right: 0px; margin-left: 0px;">スタート &gt; 管理ツール &gt; サービス &gt; Visual Studio Team Foundation Server Task Scheduler Service 開始<br></p><p style="margin-right: 0px; margin-left: 0px;"><br></p><p style="margin-right: 0px; margin-left: 0px;">要確認<span id="unei" class="writely-comment" style="background-color: rgb(255, 255, 215);">未テスト、復旧したデータ状態なったいることをクライアントから確認できたが、データを入れたりしてみないと不安 -takanobu watanabe 6/8/09 7:49 PM</span>&nbsp;<br /> </p>データの登録など、無事できた。<span id="xdxf" class="writely-comment" style="background-color: rgb(255, 255, 215);"> -takanobu watanabe 6/10/09 5:19 PM</span>&nbsp;</div><br><br><div style="margin-left: 40px;"><br></div><br><br><br><br><br><br><br></div><br><br></div><br /><p id="temp_br"></p><br>
